<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>TribeDB - MySQL分表分库数据中间件 for Node.js</title>
    <link href="http://cdn.bootcss.com/highlight.js/8.1/styles/atelier-forest.light.min.css" rel="stylesheet">
    <link rel='stylesheet' href='style.css'>

  </head>
  <body>
    <h1>TribeDB - 分布式集群储存框架 - Node.js</h1>
    <p>TribeDB 是一个MySQL分表分库数据中间件，实现MySQL数据的分布式集群储存管理。在处理海量数据、高并发访问时，获得更加优越的性能及横向扩展能力。它包含以下主要特性:</p>
    <ul>
      <li>可伸缩、高扩展的架构</li>
      <li>自动路由分库，维护数据库连接池</li>
      <li>支持数据表的“横向”和“纵向”分表</li>
      <li>支持“一主多从”式读写分离</li>
      <li>分布式并行处理，成倍提升性能</li>
      <li>对应用层隐藏数据来源及技术细节</li>
    </ul>
    <p>拥有以上特点意味着，可随时通过增加普通级别数据库服务器的方式，方便地扩展整体系统性能，而无需修改业务层架构和代码。理论上TribeDB的扩展能力上线在于主库单表插入性能和主从数据同步开销。通过合理设计“横向”和“纵向”分表和数据切分粒度，可轻松应对上亿级别的数据量和访问请求。</p>
    <p>本文档包括 TribeDB 详细API说明和对应的最优数据库设计建议。</p>

    <a href="https://github.com/jojoin/TribeDB"><img style="position: fixed; top: 0; right: 0; border: 0;" src="fork.png" alt="Fork me on GitHub"></a>

    <div class="example">
      <h3>
        目录：
      </h3>
      <ul class="menu">
        <li><a href="#example">快速上手</a></li>
        <li><a href="#setup">安装</a>环境与依赖</li>
        <li><a href="#config">config</a>数据库设置</li>
        <ul>
          <li><a href="#config-db">db()</a>设置要操作的数据表</li>
          <li><a href="#config-dist">dist()</a>数据表与数据库的从属关系</li>
          <li><a href="#config-default_db">default_db()</a>设置默认数据库</li>
        </ul>
        <li><a href="#pool">pool</a>数据库连接池</li>
        <ul>
          <li><a href="#pool-query">query()</a>执行sql语句</li>
          <li><a href="#pool-destroy">destroy()</a>关闭所有连接</li>
        </ul>
        <li><a href="#Query">Query</a>请求对象</li>
        <ul>
          <li><a href="#db-table">table()</a>设置要操作的数据表</li>
          <li><a href="#db-field">field()</a>设置查询的字段</li>
          <li><a href="#db-data">data()</a>插入或更新的数据</li>
          <li><a href="#db-where">where()</a>查询条件</li>
          <li><a href="#db-where_in">where_in()</a></li>
          <!--
          <li><a href="#db-or_where">or_where()</a></li>
          <li><a href="#db-where_in">or_where_in()</a></li>
          <li><a href="#db-where_not_in">where_not_in()</a></li>
          <li><a href="#db-or_where_not_in">or_where_not_in()</a></li>
          <li><a href="#db-where_between">where_between()</a>查找区间</li>
          <li><a href="#db-or_where_between">or_where_between()</a></li>
          <li><a href="#db-where_not_between">where_not_between()</a></li>
          <li><a href="#db-or_where_not_between">or_where_not_between()</a></li>
          <li class="line"></li>
          <li><a href="#db-like">like()</a>模糊查找</li>
          <li><a href="#db-or_like">or_like()</a></li>
          <li><a href="#db-not_like">not_like()</a></li>
          <li><a href="#db-or_not_like">or_not_like()</a></li>
          <li class="line"></li>
          -->
          <li><a href="#db-order_by">order_by()</a>排序</li>
          <li><a href="#db-group_by">group_by()</a>分组</li>
          <li><a href="#db-limit">limit()</a>限制或分页</li>
          <li><a href="#db-insert">insert()</a>数据储存</li>
          <li><a href="#db-delete">delete()</a>数据删除</li>
          <li><a href="#db-update">update()</a>数据更新</li>
          <li><a href="#db-select">select()</a>数据查询</li>
          <!--
          <li><a href="#db-count">count()</a>数据统计</li>
          <li class="line"></li>
          <li><a href="#db-join">join()</a>分表联合请求</li>
          <li class="line"></li>
          -->
          <li><a href="#db-reset">reset()</a>重置数据操作对象</li>
        </ul>
        <li><a href="#database-design">数据库设计</a></li>
      </ul>
    </div>


    <div class="example">
      <h3>
        <a name="example" href="#example" title="锚链接">#</a>
        快速上手：
      </h3>
      <pre class="source"><code>var tribe = require('tribedb')
  , Query = tribe.Query;
// 添加一个数据库配置
tribe.config.db('db1',{user:'root'});
// 直接执行sql
tribe.pool.query('SELECT 1+1 AS num', { db: 'db1' }, function(err, rows, fields){
  // 结果
});
//插入封装
new Query('post').data({title:'标题'}).insert(function(err, data){
  console.log(err);
  console.log(data);
});
//查询封装
new Query('post').where('title','标题').order_by('time','DESC').limit(1).select(function(err, data){
  console.log(err);
  console.log(data);
});</code></pre>
    </div>
    <p>TribeDB 通过全局唯一的表名，自动连接对应的数据库，并通过分表配置，将操作映射到涉及的分表，同时完成读写分离。
    一切都由 TribeDB 自动完成，业务层不必关心数据的位置。当数据库负载过高需要添加服务器时，只需简单修改配置文件而不必修改业务代码，甚至将整个架构推倒重来。继续阅读本文档详细了解如何使用。</p>


    <div class="example">
      <h3>
        <a name="setup" href="#setup" title="锚链接">#</a>
        安装
      </h3>
      <p>推荐采用 <a href="https://www.npmjs.org/search?q=tribedb" target="_black">NPM</a> 方式安装 TribeDB。也可以 <a href="https://github.com/yangjiePro/TribeDB/archive/master.zip" target="_black">下载源码</a>，但需要自己处理依赖。</p>
      <pre class="source"><code>$ npm install tribedb

#tribedb@0.2.1 node_modules\tribedb
#└── mysql@2.5.2 (require-all@0.0.8, bignumber.js@1.4.1, readable-stream@1.1.13)</code></pre>
    </div>


    <div class="example">
      <h3>
        <a name="config" href="#config" title="锚链接">#</a>
        config　数据库配置
      </h3>
      
      <div class="example indent">
        <h3>
          <a name="config-db" href="#config-db" title="锚链接">#</a>
          db(name, conf)　设置数据库
        </h3>
        <div class="param">
          <p><em>name</em><var>[string]</var>: 数据库名称。</p>
          <p><em>conf</em><var>[object]</var> or <var>[array]</var>：连接配置</p>
        </div>
        <p>设置一个或多个数据库，并可配置查询从库。使用示例：</p>
        <pre class="source"><code>var config = require('tribedb').config;
// 用法示例：
// [host,user,password,port,slave] ， slave 表示是否为从库
config.db('db1', ['localhost', 'root', ...]);
// 对象形式，并设置为 db1 的从库
config.db('db1', {
  host: 'localhost',
  user: 'root',
  ...
  slave: true
});</code></pre>
      </div>
      
      <div class="example indent">
        <h3>
          <a name="config-default_db" href="#config-default_db" title="锚链接">#</a>
          default_db(dbname)　数据表与数据库的从属关系
        </h3>
        <div class="param">
          <p><em>dbname</em><var>[string]</var>：默认查询的数据库名称。</p>
        </div>
        <p>当未指定库时，查询默认使用的库，和未指定的数据表默认保存的库。如果不调用此函数进行设置，则第一个添加的数据库为默认。使用示例：</p>
        <pre class="source"><code>var config = require('tribedb').config;
// 用法示例：
config.default_db('db1');
  </code></pre>
      </div>
      
      
      <div class="example indent">
        <h3>
          <a name="config-dist" href="#config-dist" title="锚链接">#</a>
          dist(db, tables)　数据表与数据库的从属关系
        </h3>
        <div class="param">
          <p><em>db</em><var>[string]</var>: 数据库名称。</p>
          <p><em>tables</em><var>[string]</var> or <var>[array]</var>：数据表</p>
        </div>
        <p>使用示例：</p>
        <pre class="source"><code>var config = require('tribedb').config;
// 用法示例：
config.dist('db1', ['user', 'post', 'comment', ...]);
// 或者逗号隔开的字符串
config.dist('db1', 'user, post, comment, ...');</code></pre>
      </div>
      

    </div>



    <div class="example">
      <h3>
        <a name="pool" href="#pool" title="锚链接">#</a>
        pool　数据库连接池
      </h3>
      
      <div class="example indent">
        <h3>
          <a name="pool-query" href="#pool-query" title="锚链接">#</a>
          query(sql, [opts,] callback)　在连接池中取一条连接并执行 sql 语句
        </h3>
        <div class="param">
          <p><em>sql</em><var>[string]</var>: MySQL 语句。</p>
          <p><em>opts</em><var>[object]</var>：配置项，包含：</p>
          <p>　·<em>db</em><var>[string]</var>：要连接的数据库名称，不设置使用默认的库</p>
          <p>　·<em>table</em><var>[string]</var>从表名称自动映射到对应的库</p>
          <p>　·<em>slave</em><var>[bool]</var>是否优先使用从库（没有则使用主库）</p>
          <p><em>callback</em><var>[function]</var>：执行结果回调</p>
        </div>
        <p>。使用示例：</p>
        <pre class="source"><code>var pool = require('tribedb').pool;
// 用法示例（使用默认库）：
pool.query('select * from tag;', function(err, rows, fields){
    // 结果
});
// 连接 user 表 所在的库
pool.query('select * from user;', {table: 'user'}, function(err, rows, fields){
    // 结果
});</code></pre>
      </div>
    
      <div class="example indent">
        <h3>
          <a name="pool-destroy" href="#pool-destroy" title="锚链接">#</a>
          destroy()　销毁所有数据库连接
        </h3>
      </div>
    

    </div>


    <div class="example">
      <h3>
        <a name="Query" href="#Query" title="锚链接">#</a>
        Query([table])　数据库处理对象
      </h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：要执行操作的数据表名。也可以稍后调用
        <a href="#db-table"><code class="inline">table()</code></a>函数指定。</p>
      </div>
      <p><code class="inline">Query</code>返回一个查询对象，包含一系列封装的方法，完成数据的增删改查操作。对象方法如下：</p>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-table" href="#db-table" title="锚链接">#</a>
        table(table)　指定进行操作的数据表
      </h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：要执行操作的数据表名。</p>
      </div>
      <p>可在<a href="#Query"><code class="inline">Query()</code></a>中指定数据表。</p>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-field" href="#db-field" title="锚链接">#</a>
        field(cols)　设置查询的字段
      </h3>
      <div class="param">
        <p><em>cols</em>=<var>[string]</var> or <var>[array]</var>：查询时要返回的内容（包含字段名或统计等）。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例
db.field('count(*)')
db.field('id as uid , name')
db.field(['id','name'])
db.field('id as uid','name')
db.field(['id','name as nick'])
      </code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-data" href="#db-data" title="锚链接">#</a>
        data(data)　插入或修改数据
      </h3>
      <div class="param">
        <p><em>data</em><var>[object]</var>：要插入或修改的数据。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.data({id: 1})              // 设置 {id:1} 
db.data({key: "value"})       // 追加 {id:1, key: "value"}
db.data({id: 2})              // 覆盖 {id:2, key: "value"}
db.data("foo", "bar")         // 追加 {id:2, key: "value", foo: "bar"}</code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-where" href="#db-where" title="锚链接">#</a>
        where(whe [, ...])　筛选条件
      </h3>
      <div class="param">
        <p><em>whe</em>：筛选条件。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.where("id", 1)              // WHERE id = 1
db.where("id", 1, ">")         // WHERE id > 1
db.where("id", 1, ">" ,'or')         // WHERE OR id > 1
db.where("id=1")               // WHERE id = 1
db.where({'id':1, 'num':2})  // WHERE id > 1 AND num = 2
      </code></pre>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-where_in" href="#db-where_in" title="锚链接">#</a>
        where_in(field, list)　WHERE IN()条件
      </h3>
      <div class="param">
        <p><em>field</em>：字段名。</p>
        <p><em>list</em>：有效值列表。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.where_in("id", [1,2])              // WHERE id IN(1,2)
// 等同于：
db.where("id in(1,2)")
      </code></pre>
    </div>

<!--

    <div class="example indent">
      <h3>
        <a name="db-or_where" href="#db-or_where" title="锚链接">#</a>
        or_where(whe [, ...])　WHERE OR 条件
      </h3>
      <div class="param">
        <p><em>whe</em>：筛选条件。</p>
      </div>
      <pre class="source"><code>var db = createQuery('user');
// 正确用法示例：
db.or_where("id", 1)              // WHERE id = 1 OR ...
// 等同于：
db.where("id", 1, '=', 'OR')
      </code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-or_where_in" href="#db-or_where_in" title="锚链接">#</a>
        or_where_in(field, list)　WHERE IN() OR 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-where_not_in" href="#db-where_not_in" title="锚链接">#</a>
        where_not_in(field, list)　WHERE NOT IN() 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-or_where_not_in" href="#db-or_where_not_in" title="锚链接">#</a>
        or_where_not_in(field, list)　WHERE NOT IN() OR 条件
      </h3>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-where_between" href="#db-where_between" title="锚链接">#</a>
        where_between(field, min[, max])　WHERE BETWEEN AND 条件
      </h3>
      <div class="param">
        <p><em>field</em>：字段名。</p>
        <p><em>min</em>：起始值。</p>
        <p><em>max</em>：总之值。</p>
      </div>
      <pre class="source"><code>var db = createQuery('user');
// 正确用法示例：
db.where_between("id", 1, 10)     // WHERE id BETWEEN 1 AND 10
db.where_between("id", [1,10])    // WHERE id BETWEEN 1 AND 10
// 等同于：
db.where("id between 1 and 10")
      </code></pre>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-or_where_between" href="#db-or_where_between" title="锚链接">#</a>
        or_where_between(field, min[, max])　WHERE BETWEEN AND OR 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-or_where_between" href="#db-or_where_between" title="锚链接">#</a>
        or_where_between(field, min[, max])　WHERE BETWEEN AND OR 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-where_not_between" href="#db-where_not_between" title="锚链接">#</a>
        where_not_between(field, min[, max])　WHERE NOT BETWEEN AND 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-or_where_not_between" href="#db-or_where_not_between" title="锚链接">#</a>
        or_where_not_between(field, min[, max])　WHERE NOT BETWEEN AND OR 条件
      </h3>
    </div>



    <div class="example indent">
      <h3>
        <a name="db-like" href="#db-like" title="锚链接">#</a>
        like(field, value)　WHERE LIKE 条件
      </h3>
      <div class="param">
        <p><em>field</em>：字段名。</p>
        <p><em>value</em>：匹配值。</p>
      </div>
      <pre class="source"><code>var db = createQuery('user');
// 正确用法示例：
db.like('name', '%sam%')          // WHERE name LIKE "%sam%"
db.like('name', 'sam', 'both')     // WHERE name LIKE "%sam%"
db.like('name', 'sam', 'left')     // WHERE name LIKE "sam%"
db.like('name', 'sam', 'right')    // WHERE name LIKE "%sam"
// 等同于：
db.where('name like "%sam%" ')
      </code></pre>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-or_like" href="#db-or_like" title="锚链接">#</a>
        or_like(field, value)　WHERE LIKE OR 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-not_like" href="#db-not_like" title="锚链接">#</a>
        not_like(field, value)　WHERE NOT LIKE 条件
      </h3>
    </div>

    <div class="example indent">
      <h3>
        <a name="db-or_not_like" href="#db-or_not_like" title="锚链接">#</a>
        or_not_like(field, value)　WHERE NOT LIKE OR 条件
      </h3>
    </div>

-->

    <div class="example indent">
      <h3>
        <a name="db-order_by" href="#db-order_by" title="锚链接">#</a>
        order_by(field [, desc])　排序
      </h3>
      <div class="param">
        <p><em>field</em>：字段名。</p>
        <p><em>desc</em>：是否为降序。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.order_by('id')          // ORDER BY id
db.order_by('id', true)    // ORDER BY id DESC
db.order_by('id', 'DESC')    // ORDER BY id DESC
db.order_by('id', 'ASC')    // ORDER BY id ASC
      </code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-group_by" href="#db-group_by" title="锚链接">#</a>
        group_by(field)　分组
      </h3>
      <div class="param">
        <p><em>field</em>：字段名。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.group_by('id')          // GROUP BY id
      </code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-limit" href="#db-limit" title="锚链接">#</a>
        limit([start], limit)　分页数量
      </h3>
      <div class="param">
        <p><em>start</em>：开始位置。</p>
        <p><em>limit</em>：数量。</p>
      </div>
      <pre class="source"><code>var db = createQuery('user');
// 正确用法示例：
db.limit(1)          // LIMIT 1
db.limit(2, 2)          // LIMIT 2, 2
      </code></pre>
    </div>



    <div class="example indent">
      <h3>
        <a name="db-insert" href="#db-insert" title="锚链接">#</a>
        insert(callback)　插入（新增）数据
      </h3>
      <div class="param">
        <p><em>callback</em><var>[function]</var>：插入完成回调。<code>callback(err, data, fidlds)</code>接受两个参数：<var>err</var>为解析或执行时可能出现的错误（无错则为null）。<var>data</var>操作成功后返回的数据。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.data({name: "John"}).insert(function(err, data, fidlds){
  // console.log(err);
  console.log(data);
  /*
  { fieldCount: 0,
    affectedRows: 1,
    insertId: 8,
    serverStatus: 2,
    warningCount: 1,
    message: '',
    protocol41: true,
    changedRows: 0 }
  */
},{
  //obj: true
  //db: true
  //sql: true
});
      </code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-delete" href="#db-delete" title="锚链接">#</a>
        delete(callback)　删除
      </h3>
      <div class="param">
        <p><em>callback</em><var>[function]</var>：删除完成回调。与<a href="#db-insert" title="锚链接">insert</a>相同。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.where({name: 'John Smith'}).delete(function(err, data, fidlds){
  console.log(data);
});
      </code></pre>
    </div>



    <div class="example indent">
      <h3>
        <a name="db-update" href="#db-update" title="锚链接">#</a>
        update(callback)　修改（更新）数据
      </h3>
      <div class="param">
        <p><em>callback</em><var>[function]</var>：删除完成回调。与<a href="#db-insert" title="锚链接">insert</a>相同。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.where({name: 'John'}).data({name: 'John Smith'}).update(function(err, data){
  console.log(data);
});
      </code></pre>
    </div>


    <div class="example indent">
      <h3>
        <a name="db-select" href="#db-select" title="锚链接">#</a>
        select(callback)　查询数据
      </h3>
      <div class="param">
        <p><em>callback</em><var>[function]</var>：删除完成回调。与<a href="#db-insert" title="锚链接">insert</a>相同。</p>
      </div>
      <pre class="source"><code>var db = new Query('user');
// 正确用法示例：
db.where('name', 'John Smith').select(function(err, data){
  console.log(data);
  /*
  [ { id: 1, name: 'John Smith', create_time: 0 } ]
  */
});
      </code></pre>
    </div>

    <!--
    <div class="example indent">
      <h3>
        <a name="db-count" href="#db-count" title="锚链接">#</a>
        count([callback], [opt])　统计数据行数
      </h3>
      <div class="param">
        <p><em>callback</em><var>[function]</var>：删除完成回调。<code>callback(err, data)</code>接受两个参数：<var>err</var>为解析或执行时可能出现的错误（无错则为null）。<var>data</var>为统计到的所有分表的数据条数之和（整数类型）。</p>
        <p><em>opt</em><var>[object]</var>：相关选项，与<a href="#db-insert" title="锚链接">insert</a>相同。</p>
      </div>
      <p>此函数用于方便的统计数据行数。其内部为对<code class="inline">SELECT count(*) FROM ... WHERE ...</code>的封装</p>
      <pre class="source"><code>var db = createQuery('user');
// 正确用法示例：
db.where({name: 'John Smith'}).count(function(err, num){
  console.log(num);
});
      </code></pre>
    </div>
    


    <div class="example indent">
      <h3>
        <a name="db-join" href="#db-join" title="锚链接">#</a>
        join(table[, para ....])　纵向分表联合处理
      </h3>
      <p>TribeDB 不仅支持数据表的“横向”切分，还对“纵向”拆表的增删改查操作进行了封装。</p>
      <p>假设将一个大的 user 表拆分成三个表：</p>
      <p>一、user 表储存头像昵称等常用数据；二、user_info 表储存用户简介、地域等不常用信息；三、user_conf 表储存用户的选项设置。三个表都以 id 字段作为自增主键，实现关联。</p>
      <pre class="source"><code>var db = createQuery('user');</code></pre>
      <p>同时向三个表插入数据，并以字段 id 作为三个表的关联字段。可联合插入任意熟练的关联表。</p>
      <h3>　join(table, data, field)　联合插入</h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：将要联合插入的表名。</p>
        <p><em>data</em><var>[object]</var>：要插入的数据。</p>
        <p><em>field</em><var>[string]</var>：分表联合字段。</p>
      </div>
      <pre class="source"><code>// 联表插入：
db.data({name: "John"}) // 插入后将得到自增id值，由于下一步联表插入。
  .join('user_info', {intro: "My name is John."},'id') // 联表字段为id，值取主表插入的key为id的值，不存在则取自增主键。
  .join('user_conf', {}, 'id') // data 为空，表示除了id值，其它字段不存在或使用默认值
  .insert(function(err, data){
    console.log(err);
    console.log(data);
  });</code></pre>
      <p>某些时候，表之间并没有关联字段，或者仅仅只是需要同时向多个表插入数据，也可以使用联合查询。</p>
      <pre class="source"><code>// 多表同时插入：
db.data({name: "John"}) 
  .join('user_info', {id: 2, intro: "My name is Sam."}) // data 指定 id 值，覆盖插入user表时返回的自增id。
  // .join('user_info', {intro: "My name is Sam."}, null) // 联表字段为 null 或 undefined ，表示不进行任何联表操作，各自分开执行插入动作。
  .insert(function(err, data){
    console.log(err);
    console.log(data);
  });</code></pre>

      <h3>　join(table, field, [limit])　联合删除</h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：将要联合删除的表名。</p>
        <p><em>field</em><var>[string]</var>：where 条件指定字段。</p>
        <p><em>limit</em><var>[number]</var>：数量限制。</p>
      </div>
      <pre class="source"><code>// 联表删除：
db.where('id', 1).limit(1) // 删除 id=1 的一行
  .join('user_info','id') // 联表字段为id，条件拷贝主表的条件"id=1"，limit也与主表相同
  .join('user_conf', 'id', 2) // 删除条件相同，但limit=2
  .delete(function(err, data){
    console.log(err);
    console.log(data);
  });</code></pre>

      <h3>　join(table, data, field, [limit])　联合更新</h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：将要联合更新的表名。</p>
        <p><em>data</em><var>[object]</var>：要更新的数据。</p>
        <p><em>field</em><var>[string]</var>：where 条件指定字段。</p>
        <p><em>limit</em><var>[number]</var>：数量限制。</p>
      </div>
      <pre class="source"><code>// 联表更新：
db.where('id', 1).data({name: "John"}) // 将用户姓名改为 John
  .join('user_info',{intro: "my name is John"},'id') // 联表字段为id，条件拷贝主表的条件"id=1"，limit也与主表相同
  .join('user_conf',{set: "none"},'id', 2) // 更新条件相同，但limit=2
  .update(function(err, data){
    console.log(err);
    console.log(data);
  });</code></pre>

      <h3>　join(table, [columns], [field], [limit])　联合查询</h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：将要联合更新的表名。</p>
        <p><em>columns</em><var>[object]</var>：要返回的字段。默认返回全部。</p>
        <p><em>field</em><var>[string]</var>：where 条件指定字段。默认为 "id"。当where条件中不包含field字段时，从主表查询结果里取的key与field相同的值，并用其作为 where in 条件，查询其他联表，按field字段合并数据并返回。</p>
        <p><em>limit</em><var>[number]</var>：数量限制。</p>
      </div>
      <pre class="source"><code>// 联表查询：
db.where('id', 1).limit(1) // 查询id=1的用户
  .join('user_info',null,'id') // 联表字段为id，条件拷贝主表的条件"id=1"，limit也与主表相同，columns值为null或undefined时，返回全部数据。
  .join('user_conf',['setting','config'],'id', 2) // 查询条件相同，但limit=2，返回setting和config两个字段的内容
  .select(function(err, data){
    console.log(err);
    console.log(data);
  });</code></pre>

    </div>


    <div class="example">
      <h3>
        <a name="destroy" href="#destroy" title="锚链接">#</a>
        destroy()　断开数据库连接，释放资源。
      </h3>
      <p>如果没有其他监听端口等操作，则会退出脚本。</p>
    </div>


    <div class="example">
      <h3>
        <a name="version" href="#version" title="锚链接">#</a>
        version()　返回当前 TribeDB 的版本号
      </h3>
      <pre class="source"><code>var tribe = require('tribedb');
var version = tribe.version();
// 1.2.5</code></pre>
    </div>


-->
    <div class="example">
      <h3>
        <a name="database-design" href="#database-design" title="锚链接">#</a>
        数据库设计
      </h3>
      <p>对数据表名称进行简单的修改，就能使用 TribeDB 的分表功能。数据表的扩容，分表定位查询，一切将自动完成。</p>
      <p>将需要“横向”切分的数据表名称后面，添加 "_0" 后缀，并在配置文件中指出。</p>
      <p>例如：将 user 表切分为每一百万用户一个表，只需设置两处：</p>
      <p>　　一、则在数据库新建 "user_0" 表。（ _0 后缀）</p>
      <p>　　二、在<a href="config">配置文件</a>中的<var>[table]</var>项下添加：<code class="inline">user = 100w, id</code>。</p>
      <p>当 user_0 表数据满一百万时，TribeDB 将自动拷贝 user_0 的表结构新建名为 "user_1" 的表。用户超过两百万时，新建 "user_2"，依此类推。 </p>
      <p>【注意】：只需要新建数据表时添加 "_0" 后缀，在代码里查询更新时，不加后缀：</p>
      <pre class="source"><code>// user 表“横向”拆分
// 正确：
db.table('user').select(...);
// 错误：
db.table('user_0').select(...);</code></pre>
      <p>如果需要对指定分表进行查询或维护，使用<a href="#query">query()</a>函数：</p>
      <pre class="source"><code>// user 表“横向”拆分，查询维护指定分表
// 正确：
tribe.query('select * from user_0',function(){...}); // 需要加后缀，使用真实表名称。
// 错误：
tribe.query('select * from user',function(){...}); // 不存在user表</code></pre>
      <p><b style="color:#555">一些建议</b></p>
      <p>合理规划数据切分粒度，将可以为后期系统升级预留更多的空间。</p>
      <p>比如，对于用户user表的切分，每个分表保存十万至一百万用户，是一个比较合理的划分。但对于“用户关注”表，一百万用户一个表就显得太多了，关注是一对多的关系，最终数据行数将远大于一百万。（具体数值试关注的用户量而定）。</p>
      <p>再比如，可将一个一个超大的用户表划分为 user 、user_info 、user_conf 、user_data 四个表，用于储存不同类型或不同使用频率的用户数据。</p>
      <p>具体实际情况需要视数据库服务器性能和产品业务需要而定。</p>
      <p><br></p>
      <p>- - - TribeDB 敬上 - - -</p>
    </div>










 <div class="footer">
   <span>@ <a href="http://jojoin.github.io/TribeDB/">TribeDB</a> - 2015</span>
   <span>作者：<a href="http://jojoin.com/user/1">杨捷</a></span>
   <span>Email：<a href=mailto:yangjie@jojoin.com>yangjie@jojoin.com</a></span>
   <span>Github：<a href="https://github.com/jojoin/TribeDB">https://github.com/yangjiePro/TribeDB</a></span>
 </div>


<script type="text/javascript" src="http://lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/highlight.js/8.1/highlight.min.js"></script>
<script src="http://cdn.bootcss.com/highlight.js/8.1/languages/python.min.js"></script>

<script type="text/javascript">

  //hljs.configure({useBR: true});

  $('code').each(function(i, block) {
    hljs.highlightBlock(block);
  });


</script>


  </body>
</html>

