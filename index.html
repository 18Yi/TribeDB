<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>TribeDB - MySQL分表分库数据中间件 for Node.js</title>
    <link href="http://cdn.bootcss.com/highlight.js/8.1/styles/atelier-forest.light.min.css" rel="stylesheet">
    <link rel='stylesheet' href='style.css'>

  </head>
  <body>
    <h1>TribeDB - 分布式集群储存框架 - Node.js</h1>
    <p>TribeDB 是一个MySQL分表分库数据中间件，实现MySQL数据的分布式集群储存管理。在处理海量数据、高并发访问时，获得更加优越的性能及横向扩展能力。它包含以下主要特性:</p>
    <ul>
      <li>可伸缩、高扩展的架构</li>
      <li>自动路由分库，维护数据库连接池</li>
      <li>支持数据表的“横向”和“纵向”分表</li>
      <li>支持“一主多从”式读写分离</li>
      <li>分布式并行处理，成倍提升性能</li>
      <li>对应用层隐藏数据来源及技术细节</li>
    </ul>
    <p>拥有以上特点意味着，可随时通过增加普通级别数据库服务器的方式，方便地扩展整体系统性能，而无需修改业务层架构和代码。理论上TribeDB的扩展能力上线在于主库单表插入性能和主从数据同步开销。通过合理设计“横向”和“纵向”分表和数据切分粒度，可轻松应对上亿级别的数据量和访问请求。</p>
    <p>本文档包括 TribeDB 详细API说明和对应的最优数据库设计建议。</p>

    <a href="https://github.com/yangjiePro/TribeDB"><img style="position: fixed; top: 0; right: 0; border: 0;" src="fork.png" alt="Fork me on GitHub"></a>

    <div class="example">
      <h3>
        目录：
      </h3>
      <ul class="menu">
        <li><a href="#example">快速上手</a></li>
        <li><a href="#setup">安装</a>环境与依赖</li>
        <li><a href="#configure">configure()</a>载入或返回配置</li>
        <li><a href="#configure-format">配置文件</a>格式详解</li>
        <li><a href="#query">query()</a>执行sql请求</li>
        <li><a href="#createQuery">createQuery()</a>新建数据操作对象</li>
        <ul>
          <li><a href="#db-table">table()</a>设置要操作的数据表</li>
          <li><a href="#db-columns">columns()</a>查询返回的字段</li>
          <li><a href="#db-data">data()</a>插入或更新的数据</li>
          <li><a href="#db-reset">reset()</a>重置数据操作对象</li>
          <li class="line"></li>
          <li><a href="#db-where">where()</a>查询条件</li>
          <li><a href="#db-or_where">or_where()</a></li>
          <li><a href="#db-where_in">where_in()</a></li>
          <li><a href="#db-where_in">or_where_in()</a></li>
          <li><a href="#db-where_not_in">where_not_in()</a></li>
          <li><a href="#db-or_where_not_in">or_where_not_in()</a></li>
          <li><a href="#db-where_between">where_between()</a>查找区间</li>
          <li><a href="#db-where_not_between">where_not_between()</a></li>
          <li><a href="#db-or_where_between">or_where_between()</a></li>
          <li><a href="#db-or_where_not_between">or_where_not_between()</a></li>
          <li class="line"></li>
          <li><a href="#db-like">like()</a>模糊查找</li>
          <li><a href="#db-or_like">or_like()</a></li>
          <li><a href="#db-not_like">not_like()</a></li>
          <li><a href="#db-or_not_like">or_not_like()</a></li>
          <li class="line"></li>
          <li><a href="#db-order_by">order_by()</a>排序</li>
          <li><a href="#db-group_by">group_by()</a>分组</li>
          <li><a href="#db-group_by">limit()</a>限制或分页</li>
          <li class="line"></li>
          <li><a href="#db-join">join()</a>分表联合请求</li>
          <li class="line"></li>
          <li><a href="#db-insert">insert()</a>数据储存</li>
          <li><a href="#db-delete">delete()</a>数据删除</li>
          <li><a href="#db-update">update()</a>数据更新</li>
          <li><a href="#db-select">select()</a>数据查询</li>
        </ul>
        <li><a href="#destroy">destroy</a>关闭并销毁</li>
        <li><a href="#version">version</a>版本号</li>
      </ul>
    </div>


    <div class="example">
      <h3>
        <a name="example" href="#example" title="锚链接">#</a>
        快速上手：
      </h3>
      <pre class="source"><code>
var tribe = require('tribedb');
//载入配置文件，sync选项为true 表示同步读取解析配置文件
tribe.configure('/path/to/tribe.conf',{sync:true});
//通过数据库表名建立查询请求
var db = tribe.createQuery('my_table');
//插入封装
db.data({title:'标题'}).insert(function(err, data){
  console.log(err);
  console.log(data);
});
//查询封装
db.where('title','标题').order_by('time','DESC').limit(1).select(function(err, data){
  console.log(err);
  console.log(data);
});
//不使用封装的操作，直接执行sql
tribe.query('SELECT * FROM user_0 WHERE id=1 LIMIT 1',function(err, data){
  console.log(err);
  console.log(data);
});
      </code></pre>
    </div>
    <p>TribeDB 通过全局唯一的表名，自动连接对应的数据库，并通过分表配置，将操作映射到涉及的分表，同时完成读写分离。
    一切都由 TribeDB 自动完成，业务层不必关心数据的位置。当数据库负载过高需要添加服务器时，只需简单修改配置文件而不必修改业务代码，甚至将整个架构推倒重来。继续阅读本文档详细了解如何使用。</p>


    <div class="example">
      <h3>
        <a name="setup" href="#setup" title="锚链接">#</a>
        安装
      </h3>
      <p>推荐采用 <a href="https://www.npmjs.org/search?q=tribedb" target="_black">NPM</a> 方式安装 TribeDB。也可以 <a href="https://github.com/yangjiePro/TribeDB/archive/master.zip" target="_black">下载源码</a>，但需要自己处理依赖。</p>
      <pre class="source"><code>$ npm install tribedb

#tribedb@0.1.1 node_modules\tribedb
#└── mysql@2.5.2 (require-all@0.0.8, bignumber.js@1.4.1, readable-stream@1.1.13)</code></pre>
    </div>

    <div class="example">
      <h3>
        <a name="configure" href="#configure" title="锚链接">#</a>
        configure([src], [opt], [callback])　载入或返回配置
      </h3>
      
      <div class="param">
        <p><em>src</em>=<var>[path]</var>：从文件路径读取配置。</p>
        <p><em>src</em>=<var>[url]</var>：从url读取配置。</p>
        <p><em>src</em>=<var>[string]</var>：载入配置文件正文。</p>
        <p><em>src</em>=<var>undefined</var>：表示返回从本地读取或从网络下载的配置文件正文。</p>
      </div>
      <div class="param">
        <p><em>opt</em><var>[object]</var>：配置选项（可省略）</p>
        <p><em>opt.sync</em><var>[boolen]</var>：是否以同步方式读取解析配置文件。（注意：url加载配置时始终为异步方式）。</p>
      </div>
      <div class="param">
        <p><em>callback</em><var>[function]</var>：配置文件加载并解析完成后的回调</p>
      </div>
      <p>一般情况下，在Node.js程序启动时载入配置。当异步载入配置时，若立即调用数据操作函数将返回配置错误信息，需要等待配置加载并解析完成。
      </p>
    </div>

    <div class="example">
      <h3>
        <a name="configure-format" href="#configure-format" title="锚链接">#</a>
        配置文件格式详解
      </h3>
      <p>示例配置文件：</p>
      <pre class="source"><code>
#系统配置
[system]

master_only = db1, db2 

#数据库连接配置
[database]

master:
db1 = 127.0.0.1, 3306, root, password, my_db1
db2 = 127.0.0.1, 3306, root, password, my_db2

slave:
db1 = 127.0.0.1, , root, , my_db3
db1 = 127.0.0.2, , root, , my_db4

#分表分库配置
[table]

db1:

#分库不分表只需要列出表名，每行一个表
category
#分库，同时用id值以百万为区间切分数据
user = 100w, id

      </code></pre>
      <p>配置文件分为三部分：一、系统配置；二、数据库配置；三、分表分库配置；</p>
      <p>格式说明：井号（#）右边直到行尾的内容，被视为注释全部忽略。半角分号（;）表示换行（被替换为换行符），用于把多行“短小”的配置放在一行中显示。竖杠（|）表示将本来应该在一行配置分开放在多行，用于把一行过长的配置换行书写。（竖杠左右两侧的空格和换行符都将被删除，可放行首或行尾）。所有空格、制表符等等空白符号将被全部删除忽略。</p>
      <p>配置每一项详细说明：</p>
      <div class="param">
        <p><em>[system]</em>：声明下文的配置为系统配置。默认为此，可省略。</p>
      </div>
      <div class="param">
        <!--
        <p><em>read_only</em><var>"%"</var>,<var>[string]</var>：设置“只读模式”的数据库。值为需要设置的数据库的名称(标识)，逗号隔开。此项可用于数据拷贝迁移或结构升级时，不影响读取访问。</p>
        -->
        <p><em>master_only</em><var>"%"</var>,<var>[string]</var>：对配置读写分离的数据库，只使用 master （主库）。值为要设置的数据库标识名称，逗号隔开。<var>%</var>表示对所有库有效。</p>
      </div>
      <div class="param">
        <p><em>[database]</em>：声明下文的配置为数据库连接配置。</p>
      </div>
      <div class="param">
        <p><em>master:</em>：声明下文的配置为主从复制主库（用于增删改），可不声明，默认为主库。仅支持单个主库。命名为<var>default</var>的数据库为<a name="configure-format-default">默认数据库</a>，当sql请求未指定数据库和未指定所属库的数据表默认使用的数据库。如果不存在命名为<var>default</var>的数据库，则最先配置的主库为默认。</p>
        <p><em>slave:</em>：声明下文的配置为主从复制从库（用于查）。必须有一个主库，才能配置一个或多个从库。所有从库的名称（标识）必须与对应主库相同。</p>
        <p><em>db1 = 127.0.0.1, 3306, root, password, my_db1</em>：等号左边的“db1”为数据库名称（标识），右边为逗号隔开的连接配置，依次为IP地址、端口号、用户名，密码，目标库名</p>
      </div>
      <div class="param">
        <p><em>[table]</em>：声明下文的配置为分表分库配置。</p>
      </div>
      <div class="param">
        <p><em>db1:</em>：[database] 中定义的数据库名（标识），声明下文定义的数据表位于本库中。未定义的表将视为位于默认数据库中。</p>
        <p><em>category</em>：声明名为<var>category</var>的数据表位于数据库<var>db1</var>中。</p>
        <p><em>user = 100w, id</em>：声明名为<var>user</var>的数据表位于数据库<var>db1</var>中。
          通过<var>id</var>字段分表，以一百万为区间。分表字段类型必须为整型，默认为<var>id</var>，可省略。<var>100w</var>表示数据区间，而不是每个表的精确数据行数。</p>
      </div>
    </div>


    <div class="example">
      <h3>
        <a name="query" href="#query" title="锚链接">#</a>
        query(sql, [db], [callback])　执行 SQL 语句
      </h3>
      
      <div class="param">
        <p><em>sql</em><var>[string]</var>：要执行的 sql 语句。</p>
        <p><em>db</em><var>[string]</var>：目标数据库名称（标识）。在<a href="#configure-format">配置文件</a>中定义。不传时使用<a href="#configure-format-default">默认数据库</a>。</p>
        <p><em>callback</em><var>[function]</var>：sql执行完成后回调。<code>callback(err, data)</code>函数接受两个参数，<var>err</var>为可能出现的错误信息（无错则为null），<var>data</var>为执行成功的结果数据。</p>
      </div>
    </div>




    <div class="example">
      <h3>
        <a name="createQuery" href="#createQuery" title="锚链接">#</a>
        createQuery([table])　建立数据处理对象
      </h3>
      <div class="param">
        <p><em>table</em><var>[string]</var>：要执行操作的数据表名。也可以稍后调用
        <a href="#db-table"><code class="inline">table()</code></a>函数指定。</p>
      </div>
      <p><code class="inline">createQuery</code>新建并返回一个查询对象，包含一系列封装的方法，完成数据的增删改查操作。对象方法如下：</p>
    </div>

    <div class="example">
      <h4>
        <a name="db-table" href="#db-table" title="锚链接">#</a>
        table(table)　指定进行操作的数据表
      </h4>
      <div class="param">
        <p><em>table</em><var>[string]</var>：要执行操作的数据表名。</p>
      </div>
      <p>可在<a href="#createQuery"><code class="inline">createQuery()</code></a>指定数据表。</p>
    </div>

    <div class="example">
      <h4>
        <a name="db-columns" href="#db-columns" title="锚链接">#</a>
        columns(columns)　指定进行操作的数据表
      </h4>
      <div class="param">
        <p><em>columns</em>=<var>[string]</var>：查询时要返回的内容（包含字段名或统计等）。</p>
        <p><em>columns</em>=<var>[array]</var>：字段名数组。</p>
      </div>
      <pre class="source"><code>var db = createQuery('user');
#正确用法示例
db.columns('count(*)')
db.columns('id as uid , name')
db.columns('id','name') #任意数量参数
db.columns('id as uid','name')
db.columns(['id','name as nick'])
      </code></pre>
    </div>


























 <div class="footer">
   <span>@ <a href="http://yangjiepro.github.io/TribeDB/">TribeDB</a> - 2015</span>
   <span>作者：<a href="http://jojoin.com/user/1">杨捷</a></span>
   <span>Email：<a href=mailto:yangjie@jojoin.com>yangjie@jojoin.com</a></span>
   <span>Github：<a href="https://github.com/yangjiePro/TribeDB">https://github.com/yangjiePro/TribeDB</a></span>
 </div>


<script type="text/javascript" src="http://lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/highlight.js/8.1/highlight.min.js"></script>
<script src="http://cdn.bootcss.com/highlight.js/8.1/languages/python.min.js"></script>

<script type="text/javascript">

  //hljs.configure({useBR: true});

  $('code').each(function(i, block) {
    hljs.highlightBlock(block);
  });


</script>


  </body>
</html>

